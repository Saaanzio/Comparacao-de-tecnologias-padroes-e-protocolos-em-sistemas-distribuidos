<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #eee; color: #222; padding: 16px; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { text-align: center; margin: 8px 0 16px; color: #222; font-weight: 700; }

    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .metric { background: #fff; border: 1px solid #bbb; padding: 12px; border-radius: 2px; }
    .metric h3 { font-size: 12px; color: #555; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; }
    .metric-value { font-size: 22px; font-weight: 700; color: #111; }

    .content { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .panel { background: #fff; border: 1px solid #bbb; border-radius: 2px; padding: 14px; }
    .panel h2 { margin-bottom: 10px; color: #222; font-size: 18px; }

    .status { display: inline-block; padding: 4px 10px; border-radius: 2px; font-size: 12px; margin-bottom: 10px; border: 1px solid #aaa; }
    .status.connected { background: #e0e0e0; color: #222; }
    .status.disconnected { background: #f5f5f5; color: #555; }

    .input-group { display: flex; gap: 6px; margin-bottom: 8px; }
    input[type="text"], input[type="number"] {
      flex: 1; padding: 8px; border: 1px solid #aaa; border-radius: 2px; font-size: 14px; background: #fafafa; color: #222;
    }
    button {
      padding: 8px 12px; background: #ccc; color: #222; border: 1px solid #999; border-radius: 2px; cursor: pointer; font-size: 14px;
    }
    button:hover { background: #bbb; }
    button:disabled { background: #ddd; color: #777; cursor: not-allowed; border-color: #ccc; }

    .stress-controls { display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
    .stress-controls label { font-size: 12px; color: #444; }
    .stress-controls input { width: 90px; padding: 6px; }

    #messages { max-height: 420px; overflow-y: auto; border: 1px solid #bbb; border-radius: 2px; padding: 10px; background: #fff; }
    .message { background: #f7f7f7; padding: 8px; margin-bottom: 8px; border-radius: 2px; border-left: 3px solid #999; }
    .message-time { font-size: 11px; color: #666; margin-bottom: 4px; }
    .response-time { color: #333; font-weight: 700; }

    .scenario-notes { font-size: 12px; color: #444; margin-top: 6px; line-height: 1.3; }
    .scenario-notes div { margin-top: 2px; }
    @media (max-width: 768px) { .content { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="container">
  <h1>Teste de Carga WebSocket</h1>

  <div class="metrics">
    <div class="metric">
      <h3>Total de Mensagens</h3>
      <div class="metric-value" id="totalMessages">0</div>
    </div>
    <div class="metric">
      <h3>Tempo Medio</h3>
      <div class="metric-value" id="avgTime">0ms</div>
    </div>
    <div class="metric">
      <h3>Ultima Resposta</h3>
      <div class="metric-value" id="lastTime">-</div>
    </div>
    <div class="metric">
      <h3>Mensagens por Minuto</h3>
      <div class="metric-value" id="messagesPerMin">0</div>
    </div>
    <div class="metric">
      <h3>Tempo Minimo</h3>
      <div class="metric-value" id="minTime">-</div>
    </div>
    <div class="metric">
      <h3>Tempo Maximo</h3>
      <div class="metric-value" id="maxTime">-</div>
    </div>
  </div>

  <div class="content">
    <div class="panel">
      <h2>Enviar Mensagem</h2>
      <span class="status disconnected" id="status">Desconectado</span>

      <div class="input-group">
        <input id="message" type="text" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Enviar</button>
      </div>

      <button onclick="clearMessages()" style="width: 100%;">Limpar</button>

      <div class="stress-controls">
        <label>Mensagens: <input type="number" id="stressCount" value="100" min="1" max="1000"></label>
        <label>Atraso (ms): <input type="number" id="stressDelay" value="10" min="0" max="1000"></label>
      </div>

      <button id="stressBtn" onclick="runStressTest()" style="width: 100%; margin-top: 8px;">
        Executar Teste de Carga
      </button>

      <div class="stress-controls" style="margin-top: 8px; width: 100%;">
        <button id="idealBtn" onclick="runScenario('CENARIO IDEAL', 100, 10, 120, 0, 10)" style="flex:1;">
          Cenario Ideal
        </button>
        <button id="realistaBtn" onclick="runScenario('CENARIO REALISTA', 500, 50, 300, 2, 75)" style="flex:1;">
          Cenario Realista
        </button>
        <button id="criticoBtn" onclick="runScenario('CENARIO CRITICO', 2000, 200, 600, 12, 350)" style="flex:1;">
          Cenario Critico
        </button>
      </div>

      <div class="scenario-notes">
        <div>Ideal: 10 mensagens por segundo durante 120 segundos = 1.200 mensagens.</div>
        <div>Realista: 50 mensagens por segundo durante 300 segundos = 15.000 mensagens.</div>
        <div>Critico: 200 mensagens por segundo durante 600 segundos = 120.000 mensagens.</div>
      </div>
    </div>

    <div class="panel">
      <h2>Mensagens</h2>
      <div id="messages"></div>
    </div>
  </div>
</div>


<script>
  /*Baseado levemente nos outros k6 infelizmente*/
  let stompClient = null;
  let messageCount = 0;
  let responseTimes = [];
  let messageTimestamps = [];
  let sentMessages = new Map();
  let stressTestRunning = false;

  let minResponseTime = null;
  let maxResponseTime = null;

  let scenarioRunning = false;
  let scenarioHandles = { interval: null, timeout: null };

  function connect() {
    const socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      document.getElementById('status').className = 'status connected';
      document.getElementById('status').textContent = 'Conectado';

      /*Alterar essa rota por ela não ter relação nenhuma com usuários*/
      stompClient.subscribe('/topic/users', function(message) {
        const receivedTime = Date.now();
        const content = message.body;

        const sentTime = sentMessages.get(content);
        if (sentTime) {
          const responseTime = receivedTime - sentTime;
          updateMetrics(responseTime);
          sentMessages.delete(content);
          displayMessage(content, responseTime);
        } else {
          displayMessage(content, 0);
        }
      });
    }, function(error) {
      console.log('Error: ' + error);
      document.getElementById('status').className = 'status disconnected';
      document.getElementById('status').textContent = 'Desconectado';
    });
  }

  function sendMessage() {
    const msg = document.getElementById('message').value;
    if (msg && stompClient && stompClient.connected) {
      const timestamp = Date.now();
      sentMessages.set(msg, timestamp);
      stompClient.send("/app/sendMessage", {}, msg);
      document.getElementById('message').value = '';
    }
  }

  function displayMessage(content, responseTime) {
    const messagesDiv = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.className = 'message';

    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR');

    messageElement.innerHTML = `
      <div class="message-time">${timeString} ${responseTime > 0 ? `- <span class="response-time">${responseTime}ms</span>` : ''}</div>
      <div>${content}</div>
    `;

    messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
  }

  function updateMetrics(responseTime) {
    messageCount++;
    responseTimes.push(responseTime);
    messageTimestamps.push(Date.now());

    if (minResponseTime === null || responseTime < minResponseTime) minResponseTime = responseTime;
    if (maxResponseTime === null || responseTime > maxResponseTime) maxResponseTime = responseTime;

    document.getElementById('totalMessages').textContent = messageCount;

    const avgTime = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
    document.getElementById('avgTime').textContent = Math.round(avgTime) + 'ms';

    document.getElementById('lastTime').textContent = responseTime + 'ms';

    const oneMinuteAgo = Date.now() - 60000;
    const recentMessages = messageTimestamps.filter(time => time > oneMinuteAgo);
    document.getElementById('messagesPerMin').textContent = recentMessages.length;

    document.getElementById('minTime').textContent = (minResponseTime !== null) ? Math.round(minResponseTime) + 'ms' : '-';
    document.getElementById('maxTime').textContent = (maxResponseTime !== null) ? Math.round(maxResponseTime) + 'ms' : '-';
  }

  function clearMessages() {
    document.getElementById('messages').innerHTML = '';
    messageCount = 0;
    responseTimes = [];
    messageTimestamps = [];
    sentMessages.clear();
    minResponseTime = null;
    maxResponseTime = null;

    document.getElementById('totalMessages').textContent = '0';
    document.getElementById('avgTime').textContent = '0ms';
    document.getElementById('lastTime').textContent = '-';
    document.getElementById('messagesPerMin').textContent = '0';
    document.getElementById('minTime').textContent = '-';
    document.getElementById('maxTime').textContent = '-';
  }

  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  }

  async function runStressTest() {
    if (stressTestRunning || scenarioRunning) {
      alert('Ja existe um teste em execucao');
      return;
    }
    if (!stompClient || !stompClient.connected) {
      alert('Nao conectado ao WebSocket');
      return;
    }

    const count = parseInt(document.getElementById('stressCount').value);
    const delay = parseInt(document.getElementById('stressDelay').value);

    stressTestRunning = true;
    const btn = document.getElementById('stressBtn');
    btn.disabled = true;
    btn.textContent = 'Executando...';

    for (let i = 0; i < count; i++) {
      const msg = `Teste de carga mensagem ${i + 1}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
      const timestamp = Date.now();

      sentMessages.set(msg, timestamp);
      stompClient.send("/app/sendMessage", {}, msg);

      if (delay > 0 && i < count - 1) {
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }

    stressTestRunning = false;
    btn.disabled = false;
    btn.textContent = 'Executar Teste de Carga';
  }

  function setScenarioButtonsEnabled(enabled) {
    ['idealBtn', 'realistaBtn', 'criticoBtn'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !enabled;
    });
  }

  function runScenario(nomeCenario, vus, rps, duracaoSegundos, perdaPacotes, latenciaMedia) {
    if (scenarioRunning || stressTestRunning) {
      alert('Ja existe um teste em execucao');
      return;
    }
    if (!stompClient || !stompClient.connected) {
      alert('Nao conectado ao WebSocket');
      return;
    }

    scenarioRunning = true;
    setScenarioButtonsEnabled(false);
    console.log(`Iniciando ${nomeCenario} - vus=${vus}, rps=${rps}, duracao=${duracaoSegundos}s, perda=${perdaPacotes}%, latencia media=${latenciaMedia}ms`);

    const totalMensagens = rps * duracaoSegundos;
    let enviadas = 0;

    const tickMs = Math.max(1, Math.floor(1000 / rps));

    scenarioHandles.interval = setInterval(() => {
      if (enviadas >= totalMensagens) {
        clearInterval(scenarioHandles.interval);
        scenarioHandles.interval = null;
        finalizeScenario(`${nomeCenario} finalizado (total agendado: ${totalMensagens})`);
        return;
      }

      const drop = Math.random() * 100 < perdaPacotes;
      const atraso = latenciaMedia > 0 ? (latenciaMedia + Math.floor(Math.random() * Math.max(1, Math.floor(latenciaMedia / 2)))) : 0;

      enviadas++;
      if (drop) {
        return;
      }

      setTimeout(() => {
        if (stompClient && stompClient.connected) {
          const id = `${nomeCenario}-${Date.now()}-${enviadas}-${Math.random().toString(36).slice(2,8)}`;
          sentMessages.set(id, Date.now());
          stompClient.send("/app/sendMessage", {}, id);
        }
      }, atraso);
    }, tickMs);

    scenarioHandles.timeout = setTimeout(() => {
      if (scenarioRunning) {
        if (scenarioHandles.interval) clearInterval(scenarioHandles.interval);
        finalizeScenario(`${nomeCenario} finalizado por tempo`);
      }
    }, (duracaoSegundos + 5) * 1000);
  }

  function finalizeScenario(msg) {
    if (scenarioHandles.interval) clearInterval(scenarioHandles.interval);
    if (scenarioHandles.timeout) clearTimeout(scenarioHandles.timeout);
    scenarioHandles.interval = null;
    scenarioHandles.timeout = null;
    scenarioRunning = false;
    setScenarioButtonsEnabled(true);
    console.log(msg || 'Cenario finalizado');
  }

  connect();
</script>
</body>
</html>
